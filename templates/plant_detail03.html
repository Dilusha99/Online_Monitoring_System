<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant {{ plant_data.plant_id }} - Detail Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chartjs-adapter-date-fns.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f5f7fa; }
        
        .header { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            color: white; 
            padding: 25px 0; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header-content { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { font-size: 2.8em; margin-bottom: 10px; }
        .header .subtitle { font-size: 1.3em; opacity: 0.9; }
        .header .datetime { font-size: 1.1em; opacity: 0.8; margin-top: 10px; }
        
        .back-button { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 2px solid white; 
            padding: 12px 25px; 
            border-radius: 25px; 
            text-decoration: none; 
            display: inline-block; 
            margin-top: 15px;
            transition: all 0.3s;
            font-weight: bold;
        }
        .back-button:hover { 
            background: white; 
            color: #28a745; 
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        /* Plant Statistics Cards */
        .plant-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 25px; 
            margin-bottom: 40px; 
        }
        .stat-card { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 6px solid;
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.total-power { border-left-color: #28a745; }
        .stat-card.online-units { border-left-color: #007bff; }
        .stat-card.offline-units { border-left-color: #dc3545; }
        .stat-card.avg-power { border-left-color: #ffc107; }
        
        .stat-value { font-size: 3em; font-weight: bold; margin-bottom: 10px; }
        .stat-value.total-power { color: #28a745; }
        .stat-value.online-units { color: #007bff; }
        .stat-value.offline-units { color: #dc3545; }
        .stat-value.avg-power { color: #ffc107; }
        .stat-label { color: #666; font-size: 1.2em; font-weight: 500; }
        .stat-sublabel { color: #999; font-size: 0.9em; margin-top: 5px; }
        
        /* Chart Section */
        .chart-section { 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
            padding: 30px; 
            margin-bottom: 40px; 
        }
        .chart-section h2 { 
            color: #333; 
            margin-bottom: 25px; 
            font-size: 1.8em; 
            text-align: center;
        }
        .chart-container { 
            position: relative; 
            height: 400px; 
            background: #f8f9fa;
            border-radius: 15px; 
            padding: 20px; 
        }
        
        /* Units Grid */
        .units-section { 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
            padding: 30px; 
        }
        .units-section h2 { 
            color: #333; 
            margin-bottom: 25px; 
            font-size: 1.8em; 
        }
        .units-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); 
            gap: 25px; 
        }
        .unit-card { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 15px; 
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }
        .unit-card:hover { transform: translateY(-3px); }
        .unit-card.online { border-left-color: #28a745; }
        .unit-card.offline { border-left-color: #dc3545; opacity: 0.7; }
        
        .unit-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .unit-name { 
            font-size: 1.4em; 
            font-weight: bold; 
            color: #333; 
        }
        .unit-status { 
            padding: 8px 16px; 
            border-radius: 25px; 
            font-size: 0.85em; 
            font-weight: bold;
            text-transform: uppercase;
        }
        .unit-status.online { background: #d4edda; color: #155724; }
        .unit-status.offline { background: #f8d7da; color: #721c24; }
        
        .unit-readings { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .reading { 
            text-align: center;
            position: relative;
        }
        .reading-value { 
            font-size: 1.8em; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        .reading-value.voltage { color: #007bff; }
        .reading-value.current { color: #ffc107; }
        .reading-value.power { color: #28a745; }
        .reading-label { 
            color: #666; 
            font-size: 0.9em; 
            font-weight: 500; 
        }
        
        /* Gauge Styles */
        .gauge-container {
            width: 150px;
            height: 150px;
            margin: 10px auto;
            position: relative;
        }
        
        .gauge-canvas {
            width: 100%;
            height: 100%;
        }
        
        .gauge-value {
            position: absolute;
            top: 50%;
            left: 60%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
        }
        
        .gauge-offline {
            opacity: 0.3;
        }
        
        .unit-time { 
            text-align: center; 
            color: #999; 
            font-size: 0.85em; 
            font-style: italic; 
        }
        
        /* Status Indicators */
        .status-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 10px;
        }
        .status-dot.online { background: #28a745; animation: pulse 2s infinite; }
        .status-dot.offline { background: #dc3545; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* Live Update Indicator */
        .live-indicator { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: rgba(40, 167, 69, 0.9); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 25px; 
            font-size: 0.9em; 
            font-weight: bold;
            z-index: 1000;
        }
        
        /* Timezone indicator */
        .timezone-info {
            background: rgba(255,255,255,0.1);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-top: 5px;
            display: inline-block;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .plant-stats { grid-template-columns: 1fr; }
            .units-grid { grid-template-columns: 1fr; }
            .unit-readings { grid-template-columns: 1fr; gap: 15px; }
            .chart-container { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="live-indicator" id="liveIndicator">
        üî¥ LIVE
    </div>

    <div class="header">
        <div class="header-content">
            <h1>üè≠ {{ plant_names[plant_data.plant_id] }} Dashboard</h1>
            <div class="subtitle">
                {{ plant_data.online_units }}/{{ plant_data.total_units }} Units Online | 
                {{ "%.2f"|format(plant_data.total_power / 1000) }} MW Total Power
            </div>
            <div class="datetime" id="currentDateTime">{{ current_time.strftime("%Y-%m-%d %H:%M:%S") }}</div>
            
            <a href="/" class="back-button">‚Üê Back to Master Dashboard</a>
        </div>

    </div>

    <div class="container">
        <!-- Plant Statistics -->
        <div class="plant-stats">
            <div class="stat-card total-power">
                <div class="stat-value total-power" id="totalPower">{{ "%.2f"|format(plant_data.total_power / 1000) }}</div>
                <div class="stat-label">Total Power</div>
                <div class="stat-sublabel">MW</div>
            </div>
            <div class="stat-card online-units">
                <div class="stat-value online-units" id="onlineUnits">{{ plant_data.online_units }}</div>
                <div class="stat-label">Online Units</div>
                <div class="stat-sublabel">Currently Active</div>
            </div>
            <div class="stat-card offline-units">
                <div class="stat-value offline-units" id="offlineUnits">{{ plant_data.offline_units }}</div>
                <div class="stat-label">Offline Units</div>
                <div class="stat-sublabel">Not Responding</div>
            </div>
            <div class="stat-card avg-power">
                <div class="stat-value avg-power" id="avgPower">{{ "%.1f"|format(plant_data.average_power_per_unit) }}</div>
                <div class="stat-label">Avg Power/Unit</div>
                <div class="stat-sublabel">kW</div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <h2 id="chartTitle">‚ö°  {{ plant_names[plant_data.plant_id] }} Plant Power Trend - Last 5 Hours (SL Time)</h2>
            <div class="chart-container">
                <canvas id="plantChart"></canvas>
            </div>
        </div>

        <!-- Units Section -->
        <div class="units-section">
            <h2>üîå Unit Details</h2>
            <div class="units-grid" id="unitsGrid">
                {% for unit in plant_data.units %}
                <div class="unit-card {{ 'online' if unit.online else 'offline' }}">
                    <div class="unit-header">
                        <div class="unit-name">
                            <span class="status-dot {{ 'online' if unit.online else 'offline' }}"></span>Unit {{ unit.unit_id }}
                        </div>
                        <div class="unit-status {{ 'online' if unit.online else 'offline' }}">
                            {{ 'Online' if unit.online else 'Offline' }}
                        </div>
                    </div>
                    <div class="unit-readings">
                        <div class="reading">
                            <div class="gauge-container">
                                <canvas class="gauge-canvas" id="voltageGauge{{ unit.unit_id }}"></canvas>
                                <div class="gauge-value">
                                    <div>{{ unit.voltage_avg if unit.online else '---' }}</div>
                                    <small>V</small>
                                </div>
                            </div>
                            <div class="reading-label">Voltage</div>
                        </div>
                        <div class="reading">
                            <div class="gauge-container">
                                <canvas class="gauge-canvas" id="currentGauge{{ unit.unit_id }}"></canvas>
                                <div class="gauge-value">
                                    <div>{{ unit.current_avg if unit.online else '---' }}</div>
                                    <small>A</small>
                                </div>
                            </div>
                            <div class="reading-label">Current</div>
                        </div>
                        <div class="reading">
                            <div class="gauge-container">
                                <canvas class="gauge-canvas" id="powerGauge{{ unit.unit_id }}"></canvas>
                                <div class="gauge-value">
                                    <div>{{ unit.power if unit.online else '---' }}</div>
                                    <small>kW</small>
                                </div>
                            </div>
                            <div class="reading-label">Power</div>
                        </div>
                    </div>
                    <div class="unit-time">
                        Last update: {{ unit.timestamp if unit.online else 'No data' }}
                        {% if unit.online %}<small style="color: #28a745;"> (LK Time)</small>{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        let plantChart = null;
        // FIX: Properly parse the plant ID with error handling
        let currentPlantId = parseInt('{{ plant_data.plant_id | default("1") }}', 10);
        let updateInterval = null;

        // Validate plant ID
        if (isNaN(currentPlantId) || currentPlantId < 1) {
            console.error('Invalid plant ID, defaulting to 1');
            currentPlantId = 1;
        }

        // Initialize plant dashboard
        function initializePlantDashboard() {
            updateDateTime();
            loadPlantChart();
            initializeGauges();
            
            // Set up auto-refresh
            setInterval(updateDateTime, 1000); // Update time every second
            setInterval(refreshPlantData, 5000); // Refresh data every 5 seconds
        }

        // Initialize all gauges for units
        function initializeGauges() {
            // Get all gauge canvases and create gauges
            const gaugeCanvases = document.querySelectorAll('.gauge-canvas');
            gaugeCanvases.forEach(canvas => {
                createGauge(canvas);
            });
        }

        // Create individual gauge
        function createGauge(canvas) {
            const ctx = canvas.getContext('2d');
            const id = canvas.id;
            
            // Determine gauge type and unit ID from canvas ID
            let type, unitId, color, maxValue;
            if (id.includes('voltage')) {
                type = 'voltage';
                color = '#007bff';
                maxValue = 6500; // Max voltage
            } else if (id.includes('current')) {
                type = 'current';
                color = '#ffc107';
                maxValue = 250; // Max current
            } else if (id.includes('power')) {
                type = 'power';
                color = '#28a745';
                maxValue = 5000; // Max power
            }
            
            unitId = id.replace(`${type}Gauge`, '');
            
            // Get current value
            const valueElement = canvas.parentElement.querySelector('.gauge-value div');
            let value = parseFloat(valueElement.textContent) || 0;
            
            // Draw gauge
            drawGauge(ctx, value, maxValue, color, canvas.offsetWidth);
        }

        // Draw gauge on canvas
        function drawGauge(ctx, value, maxValue, color, size) {
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size * 0.38;
            const startAngle = -Math.PI;
            const endAngle = 0;
            
            // Clear canvas
            ctx.clearRect(0, 0, size, size);
            
            // Background arc
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.lineWidth = 20;
            ctx.strokeStyle = '#e9ecef';
            ctx.lineCap = 'round';
            ctx.stroke();
            
            // Value arc
            const valueAngle = startAngle + (value / maxValue) * (endAngle - startAngle);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, valueAngle);
            ctx.lineWidth = 20;
            ctx.strokeStyle = color;
            ctx.lineCap = 'round';
            ctx.stroke();
            
            // Center dot
            ctx.beginPath();
            ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
        }

        // Update all gauges
        function updateGauges() {
            const gaugeCanvases = document.querySelectorAll('.gauge-canvas');
            gaugeCanvases.forEach(canvas => {
                const valueElement = canvas.parentElement.querySelector('.gauge-value div');
                const value = parseFloat(valueElement.textContent) || 0;
                
                let maxValue, color;
                if (canvas.id.includes('voltage')) {
                    maxValue = 6500;
                    color = '#007bff';
                } else if (canvas.id.includes('current')) {
                    maxValue = 250;
                    color = '#ffc107';
                } else if (canvas.id.includes('power')) {
                    maxValue = 5000;
                    color = '#28a745';
                }
                
                drawGauge(canvas.getContext('2d'), value, maxValue, color, canvas.offsetWidth);
            });
        }

        // Update date and time (using local Sri Lanka time)
        function updateDateTime() {
            const now = new Date();
            // Convert to Sri Lanka time (UTC+5:30)
            const sriLankaTime = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Colombo'
            };
            
            const timeElement = document.getElementById('currentDateTime');
            if (timeElement) {
                timeElement.textContent = sriLankaTime.toLocaleString('en-CA', options).replace(',', '');
            }
        }

        // Refresh plant data
        function refreshPlantData() {
            fetch(`/api/plant/${currentPlantId}/details`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updatePlantStats(data);
                    updateUnitsGrid(data);
                    updateLiveIndicator();
                })
                .catch(error => {
                    console.error('Error refreshing plant data:', error);
                    // Update live indicator to show error
                    const indicator = document.getElementById('liveIndicator');
                    if (indicator) {
                        indicator.style.background = 'rgba(220, 53, 69, 0.9)';
                        indicator.textContent = '‚ö†Ô∏è ERROR';
                    }
                });
        }

        // Update plant statistics
        function updatePlantStats(data) {
            const elements = {
                totalPower: document.getElementById('totalPower'),
                onlineUnits: document.getElementById('onlineUnits'),
                offlineUnits: document.getElementById('offlineUnits'),
                avgPower: document.getElementById('avgPower')
            };

            if (elements.totalPower) elements.totalPower.textContent = (data.total_power / 1000).toFixed(2);
            if (elements.onlineUnits) elements.onlineUnits.textContent = data.online_units;
            if (elements.offlineUnits) elements.offlineUnits.textContent = data.offline_units;
            if (elements.avgPower) elements.avgPower.textContent = data.average_power_per_unit.toFixed(1);
        }

        // Update units grid
        function updateUnitsGrid(data) {
            const unitsGrid = document.getElementById('unitsGrid');
            if (!unitsGrid || !data.units) return;

            const unitsHtml = data.units.map(unit => `
                <div class="unit-card ${unit.online ? 'online' : 'offline'}">
                    <div class="unit-header">
                        <div class="unit-name">
                            <span class="status-dot ${unit.online ? 'online' : 'offline'}"></span>Unit ${unit.unit_id}
                        </div>
                        <div class="unit-status ${unit.online ? 'online' : 'offline'}">
                            ${unit.online ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    <div class="unit-readings">
                        <div class="reading">
                            <div class="gauge-container ${!unit.online ? 'gauge-offline' : ''}">
                                <canvas class="gauge-canvas" id="voltageGauge${unit.unit_id}"></canvas>
                                <div class="gauge-value">
                                    <div>${unit.online ? unit.voltage_avg : '---'}</div>
                                    <small>V</small>
                                </div>
                            </div>
                            <div class="reading-label">Voltage</div>
                        </div>
                        <div class="reading">
                            <div class="gauge-container ${!unit.online ? 'gauge-offline' : ''}">
                                <canvas class="gauge-canvas" id="currentGauge${unit.unit_id}"></canvas>
                                <div class="gauge-value">
                                    <div>${unit.online ? unit.current_avg : '---'}</div>
                                    <small>A</small>
                                </div>
                            </div>
                            <div class="reading-label">Current</div>
                        </div>
                        <div class="reading">
                            <div class="gauge-container ${!unit.online ? 'gauge-offline' : ''}">
                                <canvas class="gauge-canvas" id="powerGauge${unit.unit_id}"></canvas>
                                <div class="gauge-value">
                                    <div>${unit.online ? unit.power : '---'}</div>
                                    <small>kW</small>
                                </div>
                            </div>
                            <div class="reading-label">Power</div>
                        </div>
                    </div>
                    <div class="unit-time">
                        Last update: ${unit.online ? unit.timestamp : 'No data'}
                        ${unit.online ? '<small style="color: #28a745;"> (LK Time)</small>' : ''}
                    </div>
                </div>
            `).join('');
            unitsGrid.innerHTML = unitsHtml;
            
            // Reinitialize gauges after updating the grid
            setTimeout(() => {
                updateGauges();
            }, 100);
        }

        // Update live indicator
        /*function updateLiveIndicator() {
            const indicator = document.getElementById('liveIndicator');
            if (!indicator) return;
            
            indicator.style.background = 'rgba(40, 167, 69, 0.9)';
            indicator.textContent = 'üî¥ ONLINE';
            setTimeout(() => {
                indicator.style.background = 'rgba(40, 167, 69, 0.5)';
            }, 500);
        } */
        // Update live indicator

        function updateLiveIndicator() {
            const indicator = document.getElementById('liveIndicator');
            const onlineUnitsEl = document.getElementById('onlineUnits');
            if (!indicator || !onlineUnitsEl) return;

            const onlineUnits = Number(onlineUnitsEl.textContent) || 0;

            if (onlineUnits > 0) {
                // Some units active
                indicator.style.background = 'rgba(40, 167, 69, 0.9)';
                indicator.textContent = 'üü¢ ONLINE';
                setTimeout(() => {
                    indicator.style.background = 'rgba(40, 167, 69, 0.5)';
                }, 500);
            } else {
                // All units offline
                indicator.style.background = 'rgba(220, 53, 69, 0.9)';
                indicator.textContent = 'üî¥ OFFLINE';
            }
        }
        


        // Load plant chart - showing only this plant's total power
        function loadPlantChart() {
            fetch(`/api/plant/${currentPlantId}/history`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const ctx = document.getElementById('plantChart');
                    if (!ctx) return;
                    
                    if (plantChart) {
                        plantChart.destroy();
                    }
                    
                    plantChart = new Chart(ctx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: data.labels || [],
                            datasets: [{
                                label: `Plant ${currentPlantId} Total Power (MW)`,
                                data: data.power || [],
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 8,
                                pointBackgroundColor: '#28a745',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { 
                                        display: true, 
                                        text: 'Total Plant Power (MW)',
                                        font: { size: 14, weight: 'bold' }
                                    },
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value >= 1000 ? (value/1000).toFixed(1) + 'MW' : value + 'W';
                                        }
                                    }
                                },
                                x: {
                                    title: { 
                                        display: true, 
                                        text: 'Time',
                                        font: { size: 14, weight: 'bold' }
                                    },
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                }
                            },
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: { size: 12, weight: 'bold' },
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: '#28a745',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            const displayValue = value >= 1000 ? 
                                                `${(value/1000).toFixed(2)} kW` : 
                                                `${value.toFixed(2)} W`;
                                            return `Plant ${currentPlantId} Power: ${displayValue}`;
                                        },
                                        title: function(context) {
                                            return `${context[0].label} (Sri Lanka Time)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading chart:', error);
                });
        }

        // Refresh chart data every 30 seconds
        setInterval(() => {
            loadPlantChart();
        }, 30000);

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Plant Dashboard initialized for Plant ID:', currentPlantId);
            initializePlantDashboard();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (plantChart) {
                plantChart.destroy();
            }
        });
    </script>
</body>
</html>